name: Smoke Tests

# Schedule smoke tests to run:
# - Every 15 minutes during business hours (critical monitoring)
# - Every hour outside business hours
# - On-demand via workflow_dispatch
#
# Based on POST_LAUNCH_SMOKE_TEST_SCHEDULE.md requirements

on:
  # Run every 15 minutes during business hours (8am-8pm UTC)
  schedule:
    - cron: '*/15 8-20 * * *'  # Every 15 min, 8am-8pm UTC
    - cron: '0 * * * *'         # Every hour (full coverage)
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to test (default: app.wathaci.com)'
        required: false
        default: 'app.wathaci.com'
      webhook_url:
        description: 'Webhook URL to test'
        required: false

  # Also run on push to verify the smoke tests themselves work
  push:
    branches: [main]
    paths:
      - 'scripts/smoke-test-*.sh'
      - 'scripts/smoke-test-*.js'
      - '.github/workflows/smoke-tests.yml'

jobs:
  https-health-check:
    name: HTTPS Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc openssl curl
      
      - name: Make smoke test script executable
        run: chmod +x scripts/smoke-test-https.sh
      
      - name: Run HTTPS smoke test
        id: https-test
        run: |
          DOMAIN="${{ github.event.inputs.domain || 'app.wathaci.com' }}"
          bash scripts/smoke-test-https.sh "$DOMAIN"
        continue-on-error: true
      
      - name: Report test results
        if: always()
        run: |
          if [ "${{ steps.https-test.outcome }}" == "success" ]; then
            echo "âœ… HTTPS health check passed"
          else
            echo "âŒ HTTPS health check failed"
            exit 1
          fi

  webhook-smoke-test:
    name: Webhook Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run webhook smoke test
        id: webhook-test
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL || github.event.inputs.webhook_url }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "âš ï¸  WEBHOOK_URL not configured, skipping webhook test"
            echo "Configure WEBHOOK_URL secret in repository settings"
            echo "test_skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -z "$WEBHOOK_SECRET" ]; then
            echo "âŒ WEBHOOK_SECRET not configured"
            echo "Configure WEBHOOK_SECRET secret in repository settings"
            exit 1
          fi
          
          echo "test_skipped=false" >> $GITHUB_OUTPUT
          node scripts/smoke-test-webhook.js "$WEBHOOK_URL" "$WEBHOOK_SECRET"
        continue-on-error: true
      
      - name: Report test results
        if: always()
        run: |
          if [ "${{ steps.webhook-test.outputs.test_skipped }}" == "true" ]; then
            echo "âš ï¸  Webhook smoke test skipped (not configured)"
          elif [ "${{ steps.webhook-test.outcome }}" == "success" ]; then
            echo "âœ… Webhook smoke test passed"
          else
            echo "âŒ Webhook smoke test failed"
            exit 1
          fi

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [https-health-check, webhook-smoke-test]
    if: failure()
    
    steps:
      - name: Create failure summary
        run: |
          echo "## ðŸš¨ Smoke Test Failure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more smoke tests failed. Please investigate immediately." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Actions Required:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the failed test logs above" >> $GITHUB_STEP_SUMMARY
          echo "2. Check application health and logs" >> $GITHUB_STEP_SUMMARY
          echo "3. Escalate to #oncall-apps if critical" >> $GITHUB_STEP_SUMMARY
          echo "4. Update incident ticket with findings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reference:** POST_LAUNCH_SMOKE_TEST_SCHEDULE.md" >> $GITHUB_STEP_SUMMARY
      
      # This step can be extended to send Slack/PagerDuty notifications
      # by using GitHub Actions for those services
      - name: Placeholder for alert integration
        run: |
          echo "Alert would be sent to monitoring stack here"
          echo "Configure Slack webhook or PagerDuty integration as needed"
          # Example for Slack (requires SLACK_WEBHOOK_URL secret):
          # curl -X POST -H 'Content-type: application/json' \
          #   --data "{\"text\":\"ðŸš¨ Smoke test failure in ${{ github.repository }}\"}" \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
